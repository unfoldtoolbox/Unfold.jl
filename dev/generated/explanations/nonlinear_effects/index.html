<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Non-Linear effects ¬∑ Unfold.jl Timeseries Analysis &amp; Deconvolution</title><meta name="title" content="Non-Linear effects ¬∑ Unfold.jl Timeseries Analysis &amp; Deconvolution"/><meta property="og:title" content="Non-Linear effects ¬∑ Unfold.jl Timeseries Analysis &amp; Deconvolution"/><meta property="twitter:title" content="Non-Linear effects ¬∑ Unfold.jl Timeseries Analysis &amp; Deconvolution"/><meta name="description" content="Documentation for Unfold.jl Timeseries Analysis &amp; Deconvolution."/><meta property="og:description" content="Documentation for Unfold.jl Timeseries Analysis &amp; Deconvolution."/><meta property="twitter:description" content="Documentation for Unfold.jl Timeseries Analysis &amp; Deconvolution."/><script data-outdated-warner src="../../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../../assets/documenter.js"></script><script src="../../../search_index.js"></script><script src="../../../siteinfo.js"></script><script src="../../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../../">Unfold.jl Timeseries Analysis &amp; Deconvolution</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../../">Unfold Documentation</a></li><li><a class="tocitem" href="../../../installation/">Installing Julia + Unfold.jl</a></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../../../tutorials/lm_mu/">Mass univariate LM</a></li><li><a class="tocitem" href="../../../tutorials/lm_overlap/">LM overlap correction</a></li><li><a class="tocitem" href="../../../tutorials/lmm_mu/">Mass univariate Mixed Model</a></li><li><a class="tocitem" href="../../../tutorials/lmm_overlap/">LMM + overlap correction</a></li></ul></li><li><span class="tocitem">HowTo</span><ul><li><a class="tocitem" href="../../../HowTo/multiple_events/">Overlap: Multiple events</a></li><li><a class="tocitem" href="../../../HowTo/pymne/">Import EEG with üêç PyMNE.jl</a></li><li><a class="tocitem" href="../../../HowTo/standarderrors/">Standard errors</a></li><li><a class="tocitem" href="../../../HowTo/custom_solvers/">Alternative Solvers (Robust, GPU, B2B)</a></li><li><a class="tocitem" href="../../HowTo/juliacall_unfold/">üêç Calling Unfold.jl directly from Python</a></li><li><a class="tocitem" href="../../../HowTo/lmm_pvalues/">P-values for mixedModels</a></li><li><a class="tocitem" href="../../HowTo/effects/">Marginal effects (focus on non-linear predictors)</a></li><li><a class="tocitem" href="../../HowTo/unfold_io/">Save and load Unfold models</a></li></ul></li><li><span class="tocitem">Explanations</span><ul><li><a class="tocitem" href="../../../explanations/basisfunctions/">About basisfunctions</a></li><li class="is-active"><a class="tocitem" href>Non-Linear effects</a><ul class="internal"><li><a class="tocitem" href="#Generating-a-non-linear-signal"><span>Generating a non-linear signal</span></a></li><li class="toplevel"><a class="tocitem" href="#Compare-linear-and-non-linear-fit"><span>Compare linear &amp; non-linear fit</span></a></li><li><a class="tocitem" href="#Looking-under-the-hood"><span>Looking under the hood</span></a></li></ul></li><li><a class="tocitem" href="../window_length/">Window Length Effect</a></li></ul></li><li><span class="tocitem">Reference</span><ul><li><a class="tocitem" href="../../../references/extensions/">Overview of package extensions</a></li><li><a class="tocitem" href="../../../explanations/development/">Development environment</a></li><li><a class="tocitem" href="../../../references/types/">API: Types</a></li><li><a class="tocitem" href="../../../references/functions/">API: Functions</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Explanations</a></li><li class="is-active"><a href>Non-Linear effects</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Non-Linear effects</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/unfoldtoolbox/Unfold.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands">ÔÇõ</span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/unfoldtoolbox/Unfold.jl/blob/main/docs/literate/explanations/nonlinear_effects.jl" title="Edit source on GitHub"><span class="docs-icon fa-solid">ÔÅÑ</span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="[Non-linear-effects]](@id-nonlinear)"><a class="docs-heading-anchor" href="#[Non-linear-effects]](@id-nonlinear)">[Non-linear effects]](@id nonlinear)</a><a id="[Non-linear-effects]](@id-nonlinear)-1"></a><a class="docs-heading-anchor-permalink" href="#[Non-linear-effects]](@id-nonlinear)" title="Permalink"></a></h1><pre><code class="language-julia hljs">using BSplineKit, Unfold
using CairoMakie
using DataFrames
using Random
using Colors
using Missings</code></pre><h2 id="Generating-a-non-linear-signal"><a class="docs-heading-anchor" href="#Generating-a-non-linear-signal">Generating a non-linear signal</a><a id="Generating-a-non-linear-signal-1"></a><a class="docs-heading-anchor-permalink" href="#Generating-a-non-linear-signal" title="Permalink"></a></h2><p>We start with generating</p><pre><code class="language-julia hljs">rng = MersenneTwister(2) # make repeatable
n = 20 # datapoints
evts = DataFrame(:x =&gt; rand(rng, n))
signal = -(3 * (evts.x .- 0.5)) .^ 2 .+ 0.5 .* rand(rng, n)

plot(evts.x, signal)</code></pre><img src="e823264c.png" alt="Example block output"/><p>Looks perfectly non-linear - great!</p><h1 id="Compare-linear-and-non-linear-fit"><a class="docs-heading-anchor" href="#Compare-linear-and-non-linear-fit">Compare linear &amp; non-linear fit</a><a id="Compare-linear-and-non-linear-fit-1"></a><a class="docs-heading-anchor-permalink" href="#Compare-linear-and-non-linear-fit" title="Permalink"></a></h1><p>First we have to reshape it to fit to Unfold format, a 3d array,  1 channel x 1 timepoint x 20 datapoints</p><pre><code class="language-julia hljs">signal = reshape(signal, length(signal), 1, 1)
signal = permutedims(signal, [3, 2, 1])
size(signal)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">(1, 1, 20)</code></pre><p>Next we define three different models. <strong>linear</strong> <strong>4 splines</strong> and <strong>10 splines</strong> note the different formulas, one <code>x</code> the other <code>spl(x,4)</code></p><pre><code class="language-julia hljs">design_linear = [Any =&gt; (@formula(0 ~ 1 + x), [0])]
design_spl3 = [Any =&gt; (@formula(0 ~ 1 + spl(x, 4)), [0])]</code></pre>1-element Vector{Pair{DataType, Tuple{StatsModels.FormulaTerm{StatsModels.ConstantTerm{Int64}, Tuple{StatsModels.ConstantTerm{Int64}, StatsModels.FunctionTerm{typeof(spl), Vector{StatsModels.AbstractTerm}}}}, Vector{Int64}}}}:
 Any => (0 ~ 1 + :(spl(x, 10)), [0])<p>and we fit the parameters</p><pre><code class="language-julia hljs">uf_linear = fit(UnfoldModel, design_linear, evts, signal);
uf_spl3 = fit(UnfoldModel, design_spl3, evts, signal);</code></pre><p>extract the fitted values using Unfold.effects</p><pre><code class="language-julia hljs">p_linear = Unfold.effects(Dict(:x =&gt; range(0, stop = 1, length = 100)), uf_linear);
p_spl3 = Unfold.effects(Dict(:x =&gt; range(0, stop = 1, length = 100)), uf_spl3);
p_spl10 = Unfold.effects(Dict(:x =&gt; range(0, stop = 1, length = 100)), uf_spl10);
first(p_linear, 5)</code></pre><div><div style = "float: left;"><span>5√ó5 DataFrame</span></div><div style = "clear: both;"></div></div><div class = "data-frame" style = "overflow-x: scroll;"><table class = "data-frame" style = "margin-bottom: 6px;"><thead><tr class = "header"><th class = "rowNumber" style = "font-weight: bold; text-align: right;">Row</th><th style = "text-align: left;">yhat</th><th style = "text-align: left;">channel</th><th style = "text-align: left;">x</th><th style = "text-align: left;">time</th><th style = "text-align: left;">eventname</th></tr><tr class = "subheader headerLastRow"><th class = "rowNumber" style = "font-weight: bold; text-align: right;"></th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Int64" style = "text-align: left;">Int64</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Int64" style = "text-align: left;">Int64</th><th title = "DataType" style = "text-align: left;">DataType</th></tr></thead><tbody><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">1</td><td style = "text-align: right;">-0.736686</td><td style = "text-align: right;">1</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0</td><td style = "text-align: left;">Any</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">2</td><td style = "text-align: right;">-0.727303</td><td style = "text-align: right;">1</td><td style = "text-align: right;">0.010101</td><td style = "text-align: right;">0</td><td style = "text-align: left;">Any</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">3</td><td style = "text-align: right;">-0.71792</td><td style = "text-align: right;">1</td><td style = "text-align: right;">0.020202</td><td style = "text-align: right;">0</td><td style = "text-align: left;">Any</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">4</td><td style = "text-align: right;">-0.708537</td><td style = "text-align: right;">1</td><td style = "text-align: right;">0.030303</td><td style = "text-align: right;">0</td><td style = "text-align: left;">Any</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">5</td><td style = "text-align: right;">-0.699154</td><td style = "text-align: right;">1</td><td style = "text-align: right;">0.040404</td><td style = "text-align: right;">0</td><td style = "text-align: left;">Any</td></tr></tbody></table></div><p>And plot them</p><pre><code class="language-julia hljs">pl = plot(evts.x, signal[1, 1, :])
lines!(p_linear.x, p_linear.yhat)
lines!(p_spl3.x, coalesce.(p_spl3.yhat, NaN))
lines!(p_spl10.x, coalesce.(p_spl10.yhat, NaN))
pl</code></pre><img src="fc2c724d.png" alt="Example block output"/><p>What we can clearly see here, that the linear effect (blue) underfits the data, the <code>spl(x,10)</code> overfits it, but the <code>spl(x,4)</code> fits it perfectly.</p><h2 id="Looking-under-the-hood"><a class="docs-heading-anchor" href="#Looking-under-the-hood">Looking under the hood</a><a id="Looking-under-the-hood-1"></a><a class="docs-heading-anchor-permalink" href="#Looking-under-the-hood" title="Permalink"></a></h2><p>Let&#39;s have a brief look how the splines manage what they are managing.</p><p>The most important bit to understand is, that we are replacing <code>x</code> by a set of coefficients <code>spl(x)</code>. These new coefficients each tile the range of <code>x</code> (in our case from [0-1]) in overlapping areas, each which will be fit by one coefficient. Because the ranges are overlapping, we get a smooth function.</p><p>Maybe this becomes clear after looking at such a basisfunction:</p><pre><code class="language-julia hljs">term_spl = Unfold.formulas(uf_spl10)[1].rhs.terms[2]</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">spl(x, 10)</code></pre><p>This is the spline term.</p><pre><code class="language-julia hljs">typeof(term_spl)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">UnfoldBSplineKitExt.BSplineTerm{StatsModels.ContinuousTerm{Float64}, Int64}</code></pre><p>a special type generated in Unfold.jl</p><p>it has a field .fun which is the spline function. We can evaluate it at a point</p><pre><code class="language-julia hljs">const splFunction = Base.get_extension(Unfold, :UnfoldBSplineKitExt).splFunction
splFunction([0.2], term_spl)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">1√ó10 Matrix{Float64}:
 0.0  0.254707  0.562326  0.182953  1.34739e-5  0.0  0.0  0.0  0.0  0.0</code></pre><p>each column of this 1 row matrix is a coefficient for our regression model.</p><pre><code class="language-julia hljs">lines(disallowmissing(splFunction([0.2], term_spl))[1, :])</code></pre><img src="b10e9ce3.png" alt="Example block output"/><p>Note: We have to use disallowmissing, because our splines return a <code>missing</code> whenever we ask it to return a value outside it&#39;s defined range, e.g.:</p><pre><code class="language-julia hljs">splFunction([-0.2], term_spl)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">1√ó10 Matrix{Union{Missing, Float64}}:
 missing  missing  missing  missing  ‚Ä¶  missing  missing  missing  missing</code></pre><p>because it never has seen any data outside and can&#39;t extrapolate!</p><p>Okay back to our main issue: Let&#39;s plot the whole basis set</p><pre><code class="language-julia hljs">basisSet = splFunction(0.0:0.01:1, term_spl)
basisSet = disallowmissing(basisSet[.!any(ismissing.(basisSet), dims = 2)[:, 1], :]) # remove missings
ax = Axis(Figure()[1, 1])
[lines!(ax, basisSet[:, k]) for k = 1:size(basisSet, 2)]
current_figure()</code></pre><img src="6bfa0003.png" alt="Example block output"/><p>notice how we flipped the plot around, i.e. now on the x-axis we do not plot the coefficients, but the <code>x</code>-values Now each line is one basis-function of the spline.</p><p>Unfold returns us one coefficient per basis-function</p><pre><code class="language-julia hljs">Œ≤ = coef(uf_spl10)[1, 1, :]
Œ≤ = Float64.(disallowmissing(Œ≤))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">10-element Vector{Float64}:
 -0.22087936502751157
 -1.3266992189242772
 -1.2141127953366175
 -0.3601682760198117
  0.5375041304110395
  0.8663477473709839
  0.5202833888393346
 -0.4122550011276661
 -0.021571324406719897
 -0.696114834251856</code></pre><p>but because we used an intercept, we have to do some remodelling in the basisSet</p><pre><code class="language-julia hljs">X = hcat(ones(size(basisSet, 1)), basisSet[:, 1:5], basisSet[:, 7:end])</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">79√ó10 Matrix{Float64}:
 1.0  0.949272   0.0503154  0.000411356  ‚Ä¶  0.0        0.0       0.0
 1.0  0.785544   0.206379   0.00800124      0.0        0.0       0.0
 1.0  0.641815   0.333447   0.0243138       0.0        0.0       0.0
 1.0  0.516783   0.433718   0.0482409       0.0        0.0       0.0
 1.0  0.409145   0.50939    0.0786746       0.0        0.0       0.0
 1.0  0.317599   0.562661   0.114507     ‚Ä¶  0.0        0.0       0.0
 1.0  0.24084    0.59573    0.15463         0.0        0.0       0.0
 1.0  0.177567   0.610794   0.197935        0.0        0.0       0.0
 1.0  0.126477   0.610052   0.243314        0.0        0.0       0.0
 1.0  0.0862677  0.595703   0.28966         0.0        0.0       0.0
 ‚ãÆ                                       ‚ã±                       
 1.0  0.0        0.0        0.0          ‚Ä¶  0.677104   0.123299  0.000400971
 1.0  0.0        0.0        0.0             0.640464   0.214438  0.00558484
 1.0  0.0        0.0        0.0             0.5705     0.314158  0.0222119
 1.0  0.0        0.0        0.0             0.477361   0.407302  0.0569693
 1.0  0.0        0.0        0.0             0.371193   0.478711  0.116544
 1.0  0.0        0.0        0.0          ‚Ä¶  0.262145   0.513225  0.207623
 1.0  0.0        0.0        0.0             0.160365   0.495686  0.336894
 1.0  0.0        0.0        0.0             0.0759992  0.410936  0.511044
 1.0  0.0        0.0        0.0             0.0191963  0.243817  0.73676</code></pre><p>now we can weight the spline by the basisfunction</p><pre><code class="language-julia hljs">weighted = (Œ≤ .* X&#39;)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">10√ó79 Matrix{Float64}:
 -0.220879     -0.220879    -0.220879     ‚Ä¶  -0.220879    -0.220879
 -1.2594       -1.04218     -0.851496        -0.0         -0.0
 -0.0610886    -0.250568    -0.404843        -0.0         -0.0
 -0.000148157  -0.00288179  -0.00875705      -0.0         -0.0
  4.46531e-7    4.05203e-5   0.000227551      0.0          0.0
  0.0           0.0          0.0          ‚Ä¶   0.0          0.0
  0.0           0.0          0.0              0.00105113   0.000118356
 -0.0          -0.0         -0.0             -0.031331    -0.00791377
 -0.0          -0.0         -0.0             -0.00886444  -0.00525945
 -0.0          -0.0         -0.0             -0.355745    -0.512869</code></pre><p>Plotting them makes for a nice looking plot!</p><pre><code class="language-julia hljs">ax = Axis(Figure()[1, 1])
[lines!(weighted[k, :]) for k = 1:10]
current_figure()</code></pre><img src="79b21fce.png" alt="Example block output"/><p>and sum them up</p><pre><code class="language-julia hljs">lines(sum(weighted, dims = 1)[1, :])
plot!(X * Œ≤, color = &quot;gray&quot;) #(same as matrixproduct X*Œ≤ directly!)
current_figure()</code></pre><img src="aedb3040.png" alt="Example block output"/><p>And this is how you can think about splines</p><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../../../explanations/basisfunctions/">¬´ About basisfunctions</a><a class="docs-footer-nextpage" href="../window_length/">Window Length Effect ¬ª</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.5.0 on <span class="colophon-date" title="Wednesday 10 July 2024 14:15">Wednesday 10 July 2024</span>. Using Julia version 1.10.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
