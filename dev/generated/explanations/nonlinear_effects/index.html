<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Non-Linear effects ¬∑ Unfold.jl Timeseries Analysis &amp; Deconvolution</title><meta name="title" content="Non-Linear effects ¬∑ Unfold.jl Timeseries Analysis &amp; Deconvolution"/><meta property="og:title" content="Non-Linear effects ¬∑ Unfold.jl Timeseries Analysis &amp; Deconvolution"/><meta property="twitter:title" content="Non-Linear effects ¬∑ Unfold.jl Timeseries Analysis &amp; Deconvolution"/><meta name="description" content="Documentation for Unfold.jl Timeseries Analysis &amp; Deconvolution."/><meta property="og:description" content="Documentation for Unfold.jl Timeseries Analysis &amp; Deconvolution."/><meta property="twitter:description" content="Documentation for Unfold.jl Timeseries Analysis &amp; Deconvolution."/><script data-outdated-warner src="../../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../../assets/documenter.js"></script><script src="../../../search_index.js"></script><script src="../../../siteinfo.js"></script><script src="../../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../../">Unfold.jl Timeseries Analysis &amp; Deconvolution</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../../">Unfold Documentation</a></li><li><a class="tocitem" href="../../../installation/">Installing Julia + Unfold.jl</a></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../../../tutorials/lm_mu/">Mass univariate LM</a></li><li><a class="tocitem" href="../../../tutorials/lm_overlap/">LM overlap correction</a></li><li><a class="tocitem" href="../../../tutorials/lmm_mu/">Mass univariate Mixed Model</a></li><li><a class="tocitem" href="../../../tutorials/lmm_overlap/">LMM + overlap correction</a></li></ul></li><li><span class="tocitem">HowTo</span><ul><li><a class="tocitem" href="../../../HowTo/multiple_events/">Overlap: Multiple events</a></li><li><a class="tocitem" href="../../../HowTo/pymne/">Import EEG with üêç PyMNE.jl</a></li><li><a class="tocitem" href="../../../HowTo/standarderrors/">Standard errors</a></li><li><a class="tocitem" href="../../../HowTo/custom_solvers/">Alternative Solvers (Robust, GPU, B2B)</a></li><li><a class="tocitem" href="../../HowTo/juliacall_unfold/">üêç Calling Unfold.jl directly from Python</a></li><li><a class="tocitem" href="../../../HowTo/lmm_pvalues/">P-values for mixedModels</a></li><li><a class="tocitem" href="../../HowTo/effects/">Marginal effects (focus on non-linear predictors)</a></li><li><a class="tocitem" href="../../HowTo/unfold_io/">Save and load Unfold models</a></li><li><a class="tocitem" href="../../HowTo/contrasts/">Change contrasts / coding schema</a></li></ul></li><li><span class="tocitem">Explanations</span><ul><li><a class="tocitem" href="../../../explanations/basisfunctions/">About basisfunctions</a></li><li class="is-active"><a class="tocitem" href>Non-Linear effects</a><ul class="internal"><li><a class="tocitem" href="#Generating-a-non-linear-signal"><span>Generating a non-linear signal</span></a></li><li class="toplevel"><a class="tocitem" href="#Compare-linear-and-non-linear-fit"><span>Compare linear &amp; non-linear fit</span></a></li><li><a class="tocitem" href="#Looking-under-the-hood"><span>Looking under the hood</span></a></li></ul></li><li><a class="tocitem" href="../window_length/">Window Length Effect</a></li><li><a class="tocitem" href="../predict/">Predictions</a></li></ul></li><li><span class="tocitem">Reference</span><ul><li><a class="tocitem" href="../../../references/extensions/">Overview of package extensions</a></li><li><a class="tocitem" href="../../../explanations/development/">Development environment</a></li><li><a class="tocitem" href="../../references/solver/">Solver/optimizer implementations</a></li><li><a class="tocitem" href="../../../references/types/">API: Types</a></li><li><a class="tocitem" href="../../../references/functions/">API: Functions</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Explanations</a></li><li class="is-active"><a href>Non-Linear effects</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Non-Linear effects</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/unfoldtoolbox/Unfold.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands">ÔÇõ</span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/unfoldtoolbox/Unfold.jl/blob/main/docs/literate/explanations/nonlinear_effects.jl" title="Edit source on GitHub"><span class="docs-icon fa-solid">ÔÅÑ</span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="[Non-linear-effects]](@id-nonlinear)"><a class="docs-heading-anchor" href="#[Non-linear-effects]](@id-nonlinear)">[Non-linear effects]](@id nonlinear)</a><a id="[Non-linear-effects]](@id-nonlinear)-1"></a><a class="docs-heading-anchor-permalink" href="#[Non-linear-effects]](@id-nonlinear)" title="Permalink"></a></h1><pre><code class="language-julia hljs">using BSplineKit, Unfold
using CairoMakie
using DataFrames
using Random
using Colors
using Missings</code></pre><h2 id="Generating-a-non-linear-signal"><a class="docs-heading-anchor" href="#Generating-a-non-linear-signal">Generating a non-linear signal</a><a id="Generating-a-non-linear-signal-1"></a><a class="docs-heading-anchor-permalink" href="#Generating-a-non-linear-signal" title="Permalink"></a></h2><p>We start with generating data variables</p><pre><code class="language-julia hljs">rng = MersenneTwister(2) # make repeatable
n = 20 # number of datapoints
evts = DataFrame(:x =&gt; rand(rng, n))
signal = -(3 * (evts.x .- 0.5)) .^ 2 .+ 0.5 .* rand(rng, n)

plot(evts.x, signal)</code></pre><img src="22f2580f.png" alt="Example block output"/><p>Looks perfectly non-linear. Great!</p><h1 id="Compare-linear-and-non-linear-fit"><a class="docs-heading-anchor" href="#Compare-linear-and-non-linear-fit">Compare linear &amp; non-linear fit</a><a id="Compare-linear-and-non-linear-fit-1"></a><a class="docs-heading-anchor-permalink" href="#Compare-linear-and-non-linear-fit" title="Permalink"></a></h1><p>First, we have to reshape <code>signal</code> data to a 3d array, so it will fit to Unfold format:  1 channel x 1 timepoint x 20 datapoints.</p><pre><code class="language-julia hljs">signal = reshape(signal, length(signal), 1, 1)
signal = permutedims(signal, [3, 2, 1])
size(signal)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">(1, 1, 20)</code></pre><p>Next we define three different models: <strong>linear</strong>, <strong>4 splines</strong> and <strong>10 splines</strong>. Note difference in formulas: one <code>x</code>, the other <code>spl(x, 4)</code>.</p><pre><code class="language-julia hljs">design_linear = [Any =&gt; (@formula(0 ~ 1 + x), [0])];
design_spl3 = [Any =&gt; (@formula(0 ~ 1 + spl(x, 4)), [0])];
design_spl10 = [Any =&gt; (@formula(0 ~ 1 + spl(x, 10)), [0])];</code></pre><p>Next, fit the parameters.</p><pre><code class="language-julia hljs">uf_linear = fit(UnfoldModel, design_linear, evts, signal);
uf_spl3 = fit(UnfoldModel, design_spl3, evts, signal);</code></pre><p>Extract the fitted values using Unfold.effects.</p><pre><code class="language-julia hljs">p_linear = Unfold.effects(Dict(:x =&gt; range(0, stop = 1, length = 100)), uf_linear);
p_spl3 = Unfold.effects(Dict(:x =&gt; range(0, stop = 1, length = 100)), uf_spl3);
p_spl10 = Unfold.effects(Dict(:x =&gt; range(0, stop = 1, length = 100)), uf_spl10);
first(p_linear, 5)</code></pre><div><div style = "float: left;"><span>5√ó5 DataFrame</span></div><div style = "clear: both;"></div></div><div class = "data-frame" style = "overflow-x: scroll;"><table class = "data-frame" style = "margin-bottom: 6px;"><thead><tr class = "header"><th class = "rowNumber" style = "font-weight: bold; text-align: right;">Row</th><th style = "text-align: left;">yhat</th><th style = "text-align: left;">channel</th><th style = "text-align: left;">x</th><th style = "text-align: left;">time</th><th style = "text-align: left;">eventname</th></tr><tr class = "subheader headerLastRow"><th class = "rowNumber" style = "font-weight: bold; text-align: right;"></th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Int64" style = "text-align: left;">Int64</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Int64" style = "text-align: left;">Int64</th><th title = "DataType" style = "text-align: left;">DataType</th></tr></thead><tbody><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">1</td><td style = "text-align: right;">0.0328538</td><td style = "text-align: right;">1</td><td style = "text-align: right;">0.0</td><td style = "text-align: right;">0</td><td style = "text-align: left;">Any</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">2</td><td style = "text-align: right;">0.0273313</td><td style = "text-align: right;">1</td><td style = "text-align: right;">0.010101</td><td style = "text-align: right;">0</td><td style = "text-align: left;">Any</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">3</td><td style = "text-align: right;">0.0218088</td><td style = "text-align: right;">1</td><td style = "text-align: right;">0.020202</td><td style = "text-align: right;">0</td><td style = "text-align: left;">Any</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">4</td><td style = "text-align: right;">0.0162863</td><td style = "text-align: right;">1</td><td style = "text-align: right;">0.030303</td><td style = "text-align: right;">0</td><td style = "text-align: left;">Any</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">5</td><td style = "text-align: right;">0.0107638</td><td style = "text-align: right;">1</td><td style = "text-align: right;">0.040404</td><td style = "text-align: right;">0</td><td style = "text-align: left;">Any</td></tr></tbody></table></div><p>Plot them.</p><pre><code class="language-julia hljs">pl = plot(evts.x, signal[1, 1, :])
lines!(p_linear.x, p_linear.yhat)
lines!(p_spl3.x, coalesce.(p_spl3.yhat, NaN))
lines!(p_spl10.x, coalesce.(p_spl10.yhat, NaN))
pl</code></pre><img src="cbb76df1.png" alt="Example block output"/><p>We see here, that the linear effect (blue line) underfits the data, the yellow <code>spl(x, 10)</code> overfits it, but the green <code>spl(x, 4)</code> fits it perfectly.</p><h2 id="Looking-under-the-hood"><a class="docs-heading-anchor" href="#Looking-under-the-hood">Looking under the hood</a><a id="Looking-under-the-hood-1"></a><a class="docs-heading-anchor-permalink" href="#Looking-under-the-hood" title="Permalink"></a></h2><p>Let&#39;s have a brief look how the splines manage what they are managing.</p><p>The most important bit to understand is, that we are replacing <code>x</code> by a set of coefficients <code>spl(x)</code>. These new coefficients each tile the range of <code>x</code> (in our case, from [0-1]) in overlapping areas, while each will be fit by one coefficient. Because the ranges are overlapping, we get a smooth function.</p><p>Maybe this becomes clear after looking at a <code>basisfunction</code>:</p><pre><code class="language-julia hljs">term_spl = Unfold.formulas(uf_spl10)[1].rhs.terms[2]</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">spl(x, 10)</code></pre><p>This is the spline term. Note, this is a special type available in the BSplineKit.jl extension in Unfold.jl. It&#39;s abstract type is <code>AbstractSplineTerm</code> defined in Unfold.jl</p><pre><code class="language-julia hljs">typeof(term_spl)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">UnfoldBSplineKitExt.BSplineTerm{StatsModels.ContinuousTerm{Float64}, Int64}</code></pre><pre><code class="language-julia hljs">const splFunction = Base.get_extension(Unfold, :UnfoldBSplineKitExt).splFunction
splFunction([0.2], term_spl)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">1√ó10 Matrix{Float64}:
 0.492619  0.438047  0.0670761  0.00225775  0.0  0.0  0.0  0.0  0.0  0.0</code></pre><p>Each column of this 1-row matrix is a coefficient for our regression model.</p><pre><code class="language-julia hljs">lines(disallowmissing(splFunction([0.2], term_spl))[1, :])</code></pre><img src="8ce11a93.png" alt="Example block output"/><p>Note: We have to use <code>disallowmissing</code>, because our splines return a <code>missing</code> whenever we ask it to return a value outside its defined range, e.g.:</p><pre><code class="language-julia hljs">splFunction([-0.2], term_spl)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">1√ó10 Matrix{Union{Missing, Float64}}:
 missing  missing  missing  missing  ‚Ä¶  missing  missing  missing  missing</code></pre><p>Because it never has seen any data outside and can&#39;t extrapolate!</p><p>Back to our main issue. Let&#39;s plot the whole basis set</p><pre><code class="language-julia hljs">basisSet = splFunction(0.0:0.01:1, term_spl)
basisSet = disallowmissing(basisSet[.!any(ismissing.(basisSet), dims = 2)[:, 1], :]) # remove missings
ax = Axis(Figure()[1, 1])
[lines!(ax, basisSet[:, k]) for k = 1:size(basisSet, 2)]
current_figure()</code></pre><img src="55ef6b37.png" alt="Example block output"/><p>Notice how we flipped the plot around, i.e. now on the x-axis we do not plot the coefficients, but the <code>x</code>-values. Now each line is one basis-function of the spline.</p><p>Unfold returns us one coefficient per basis-function</p><pre><code class="language-julia hljs">Œ≤ = coef(uf_spl10)[1, 1, :]
Œ≤ = Float64.(disallowmissing(Œ≤))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">10-element Vector{Float64}:
 -0.43629459354570777
 -0.3477308181329035
  0.4538614574712754
 -0.4065207930158754
  0.7346158579524353
  0.9252913204020701
  0.27167896791779556
 -0.046335871160806175
 -0.5822988416277803
 -0.6202082891592833</code></pre><p>But because we used an intercept, we have to do some remodelling in the <code>basisSet</code>.</p><pre><code class="language-julia hljs">X = hcat(ones(size(basisSet, 1)), basisSet[:, 1:5], basisSet[:, 7:end])</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">71√ó10 Matrix{Float64}:
 1.0  0.972634     0.027217  0.000148709  ‚Ä¶  0.0         0.0       0.0
 1.0  0.705645     0.274339  0.0196948       0.0         0.0       0.0
 1.0  0.492619     0.438047  0.0670761       0.0         0.0       0.0
 1.0  0.327462     0.530129  0.135118        0.0         0.0       0.0
 1.0  0.204084     0.56237   0.216645        0.0         0.0       0.0
 1.0  0.116392     0.546557  0.304483     ‚Ä¶  0.0         0.0       0.0
 1.0  0.0582934    0.494476  0.391456        0.0         0.0       0.0
 1.0  0.0236969    0.417914  0.470391        0.0         0.0       0.0
 1.0  0.00651001   0.328658  0.534112        0.0         0.0       0.0
 1.0  0.000640778  0.238493  0.575444        0.0         0.0       0.0
 ‚ãÆ                                        ‚ã±                        
 1.0  0.0          0.0       0.0             0.500742    0.335973  0.0
 1.0  0.0          0.0       0.0             0.472071    0.412937  0.0
 1.0  0.0          0.0       0.0             0.423651    0.500839  0.0
 1.0  0.0          0.0       0.0          ‚Ä¶  0.354694    0.596875  0.00252938
 1.0  0.0          0.0       0.0             0.272257    0.677546  0.0249338
 1.0  0.0          0.0       0.0             0.186241    0.711843  0.0899373
 1.0  0.0          0.0       0.0             0.106554    0.668749  0.220272
 1.0  0.0          0.0       0.0             0.0431012   0.517244  0.438668
 1.0  0.0          0.0       0.0          ‚Ä¶  0.00579053  0.226308  0.767859</code></pre><p>Now we can weight the spline by the <code>basisfunction</code>.</p><pre><code class="language-julia hljs">weighted = (Œ≤ .* X&#39;)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">10√ó71 Matrix{Float64}:
 -0.436295    -0.436295    -0.436295    ‚Ä¶  -0.436295     -0.436295
 -0.338215    -0.245375    -0.171299       -0.0          -0.0
  0.0123527    0.124512     0.198813        0.0           0.0
 -6.04533e-5  -0.00800637  -0.0272678      -0.0          -0.0
  1.39303e-7   0.00023577   0.00165858      0.0           0.0
  0.0          0.0          0.0         ‚Ä¶   0.0           0.0
  0.0          0.0          0.0             0.000268113   1.15869e-5
 -0.0         -0.0         -0.0            -0.00199713   -0.000268309
 -0.0         -0.0         -0.0            -0.30119      -0.131779
 -0.0         -0.0         -0.0            -0.272066     -0.476232</code></pre><p>Plotting them creates a nice looking plot!</p><pre><code class="language-julia hljs">ax = Axis(Figure()[1, 1])
[lines!(weighted[k, :]) for k = 1:10]
current_figure()</code></pre><img src="a10cba2c.png" alt="Example block output"/><p>Now sum them up.</p><pre><code class="language-julia hljs">lines(sum(weighted, dims = 1)[1, :])
plot!(X * Œ≤, color = &quot;gray&quot;) #(same as matrixproduct X*Œ≤ directly!)
current_figure()</code></pre><img src="1a7f962f.png" alt="Example block output"/><p>And this is how you can think about splines.</p><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../../../explanations/basisfunctions/">¬´ About basisfunctions</a><a class="docs-footer-nextpage" href="../window_length/">Window Length Effect ¬ª</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.7.0 on <span class="colophon-date" title="Tuesday 5 November 2024 12:16">Tuesday 5 November 2024</span>. Using Julia version 1.11.1.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
