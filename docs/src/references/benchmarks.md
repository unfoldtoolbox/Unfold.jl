# Benchmarks

We ran benchmarks on 2024-11-07 as described in `./benchmark/cuda/solver_comparison.jl`. Given that some were run on a GPU, we cannot run them on continuous-integration online.

!!! important
    - Allocations are only CPU allocations - GPU allocations were not counted. 
    - Solvers other than `default_multi` are currently *NOT* multi-threaded
    - Solvers other than `default_multi` and `krylov_gpu` solve $X'Xb = X'y$ instead of $Xb=y$ directly. They are likely less accurate, but should be faster for multi-channel data, as we can precalulate cholesky, qr or similar & the to-be-inverted matrix is much smaller.

## Small Model
```julia  
n_channels = 1,
sfreq = 10,
n_splines = 4,
n_repeats = 10;
```
| **method**     | **gpu** | **time**        | **GB**          | **sizeDesign** | **n\_channels** | **overlap** | **comment**         | **percent\_X\_filled** |
|---------------:|--------:|----------------:|----------------:|---------------:|----------------:|------------:|--------------------:|-----------------------:|
| cholesky       | true    | 1.32226e-8      | 4.47035e-8      | (1190, 130)    | 1               | (0.2, 0.2)  | PosDefException(-1) | 0.0828054              |
| cholesky       | false   | **0.000629578** | 0.000721976     | (1190, 130)    | 1               | (0.2, 0.2)  |                     | 0.0828054              |
| intern         | true    | 0.000862555     | 0.000188157     | (1190, 130)    | 1               | (0.2, 0.2)  |                     | 0.0828054              |
| intern         | false   | 0.0011299       | 0.000722975     | (1190, 130)    | 1               | (0.2, 0.2)  |                     | 0.0828054              |
| qr             | true    | 0.00121084      | 0.000200748     | (1190, 130)    | 1               | (0.2, 0.2)  |                     | 0.0828054              |
| qr             | false   | 0.00158047      | 0.000792861     | (1190, 130)    | 1               | (0.2, 0.2)  |                     | 0.0828054              |
| cg             | false   | 0.00168197      | 0.0006053       | (1190, 130)    | 1               | (0.2, 0.2)  |                     | 0.0828054              |
| default\_multi | false   | 0.00195657      | **0.000155717** | (1190, 130)    | 1               | (0.2, 0.2)  |                     | 0.0828054              |
| pinv           | true    | 0.00540814      | 0.00034073      | (1190, 130)    | 1               | (0.2, 0.2)  |                     | 0.0828054              |
| cg             | true    | 0.00542955      | 0.000565797     | (1190, 130)    | 1               | (0.2, 0.2)  |                     | 0.0828054              |
| pinv           | false   | 0.00867846      | 0.00162272      | (1190, 130)    | 1               | (0.2, 0.2)  |                     | 0.0828054              |
| krylov\_gpu    | true    | 0.0314029       | 0.00131881      | (1190, 130)    | 1               | (0.2, 0.2)  |                     | 0.0828054              |

## small-to-midsize model

```julia  
n_channels = 1,
sfreq = 100,
n_splines = 4,
n_repeats = 200;
```

| **method**     | **gpu** | **time**      | **GB**         | **sizeDesign** | **n\_channels** | **overlap** | **comment**         | **percent\_X\_filled** |
|---------------:|--------:|--------------:|---------------:|---------------:|----------------:|------------:|--------------------:|-----------------------:|
| cholesky       | true    | 1.34875e-8    | 4.47035e-8     | (239522, 1210) | 1               | (0.2, 0.2)  | PosDefException(-1) | 0.00832578             |
| cg             | true    | **0.0157755** | 0.0255262      | (239522, 1210) | 1               | (0.2, 0.2)  |                     | 0.00832578             |
| intern         | true    | 0.021906      | 0.0252463      | (239522, 1210) | 1               | (0.2, 0.2)  |                     | 0.00832578             |
| qr             | true    | 0.0270078     | 0.0252594      | (239522, 1210) | 1               | (0.2, 0.2)  |                     | 0.00832578             |
| krylov\_gpu    | true    | 0.0806781     | 0.0531631      | (239522, 1210) | 1               | (0.2, 0.2)  |                     | 0.00832578             |
| pinv           | true    | 0.166997      | 0.0361954      | (239522, 1210) | 1               | (0.2, 0.2)  |                     | 0.00832578             |
| cg             | false   | 0.3312        | 0.0723347      | (239522, 1210) | 1               | (0.2, 0.2)  |                     | 0.00832578             |
| cholesky       | false   | 0.397796      | 0.0832102      | (239522, 1210) | 1               | (0.2, 0.2)  |                     | 0.00832578             |
| intern         | false   | 0.431697      | 0.0832193      | (239522, 1210) | 1               | (0.2, 0.2)  |                     | 0.00832578             |
| qr             | false   | 0.464494      | 0.0838685      | (239522, 1210) | 1               | (0.2, 0.2)  |                     | 0.00832578             |
| default\_multi | false   | 0.816558      | **0.00965242** | (239522, 1210) | 1               | (0.2, 0.2)  |                     | 0.00832578             |
| pinv           | false   | 1.17868       | 0.159741       | (239522, 1210) | 1               | (0.2, 0.2)  |                     | 0.00832578             |

## small-to-midsize: multi-channel
```julia   
n_channels = 128,
sfreq = 100,
n_splines = 4,
n_repeats = 200;
```
| **method**     | **gpu** | **time**     | **GB**     | **sizeDesign** | **n\_channels** | **overlap** | **comment**         | **percent\_X\_filled** |
|---------------:|--------:|-------------:|-----------:|---------------:|----------------:|------------:|--------------------:|-----------------------:|
| cholesky       | true    | 1.35937e-8   | 4.47035e-8 | (239522, 1210) | 128             | (0.2, 0.2)  | PosDefException(-1) | 0.00832578             |
| pinv           | true    | **0.429124** | 0.264349   | (239522, 1210) | 128             | (0.2, 0.2)  |                     | 0.00832578             |
| qr             | true    | 0.756289     | 0.255178   | (239522, 1210) | 128             | (0.2, 0.2)  |                     | 0.00832578             |
| intern         | true    | 0.790037     | **0.2537** | (239522, 1210) | 128             | (0.2, 0.2)  |                     | 0.00832578             |
| cg             | true    | 1.65654      | 0.323257   | (239522, 1210) | 128             | (0.2, 0.2)  |                     | 0.00832578             |
| cholesky       | false   | 1.78281      | 0.313473   | (239522, 1210) | 128             | (0.2, 0.2)  |                     | 0.00832578             |
| qr             | false   | 2.02552      | 0.315302   | (239522, 1210) | 128             | (0.2, 0.2)  |                     | 0.00832578             |
| cg             | false   | 2.53418      | 0.306963   | (239522, 1210) | 128             | (0.2, 0.2)  |                     | 0.00832578             |
| pinv           | false   | 2.53619      | 0.389995   | (239522, 1210) | 128             | (0.2, 0.2)  |                     | 0.00832578             |
| krylov\_gpu    | true    | 9.93721      | 0.408452   | (239522, 1210) | 128             | (0.2, 0.2)  |                     | 0.00832578             |
| intern         | false   | 13.2748      | 1.70042    | (239522, 1210) | 128             | (0.2, 0.2)  |                     | 0.00832578             |
| default\_multi | false   | 22.2904      | 1.23454    | (239522, 1210) | 128             | (0.2, 0.2)  |                     | 0.00832578             |


# large, realistic model
```julia
    n_channels = 128,
    sfreq = 500,
    n_splines = (4, 4),
    n_repeats = 500,
```
| **method**     | **gpu** | **time**    | **GB**      | **sizeDesign**  | **n\_channels** | **overlap** | **comment**             | **percent\_X\_filled** |
|---------------:|--------:|------------:|------------:|----------------:|----------------:|------------:|------------------------:|-----------------------:|
| cholesky       | true    | 1.3629e-8   | 4.47035e-8  | (3001479, 9616) | 128             | (0.2, 0.2)  | PosDefException(-1)     | 0.00166532             |
| cholesky       | false   | 1.91626e-8  | 4.47035e-8  | (3001479, 9616) | 128             | (0.2, 0.2)  | PosDefException(2760)   | 0.00166532             |
| intern         | false   | 1.92441e-8  | 4.47035e-8  | (3001479, 9616) | 128             | (0.2, 0.2)  | SingularException(9599) | 0.00166532             |
| cg             | true    | **9.12907** | 3.6506      | (3001479, 9616) | 128             | (0.2, 0.2)  |                         | 0.00166532             |
| qr             | true    | 11.0703     | 3.57265     | (3001479, 9616) | 128             | (0.2, 0.2)  |                         | 0.00166532             |
| intern         | true    | 13.2764     | **3.57118** | (3001479, 9616) | 128             | (0.2, 0.2)  |                         | 0.00166532             |
| qr             | false   | 74.5377     | 6.39948     | (3001479, 9616) | 128             | (0.2, 0.2)  |                         | 0.00166532             |
| pinv           | true    | 78.3183     | 4.25957     | (3001479, 9616) | 128             | (0.2, 0.2)  |                         | 0.00166532             |
| krylov\_gpu    | true    | 104.88      | 4.01149     | (3001479, 9616) | 128             | (0.2, 0.2)  |                         | 0.00166532             |
| pinv           | false   | 477.606     | 11.209      | (3001479, 9616) | 128             | (0.2, 0.2)  |                         | 0.00166532             |
| default\_multi | false   | 649.848     | 14.9742     | (3001479, 9616) | 128             | (0.2, 0.2)  |                         | 0.00166532             |
| cg             | false   | 913.154     | 5.72463     | (3001479, 9616) | 128             | (0.2, 0.2)  |                         | 0.00166532             |