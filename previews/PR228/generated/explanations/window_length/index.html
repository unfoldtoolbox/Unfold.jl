<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Window Length Effect ¬∑ Unfold.jl Timeseries Analysis &amp; Deconvolution</title><meta name="title" content="Window Length Effect ¬∑ Unfold.jl Timeseries Analysis &amp; Deconvolution"/><meta property="og:title" content="Window Length Effect ¬∑ Unfold.jl Timeseries Analysis &amp; Deconvolution"/><meta property="twitter:title" content="Window Length Effect ¬∑ Unfold.jl Timeseries Analysis &amp; Deconvolution"/><meta name="description" content="Documentation for Unfold.jl Timeseries Analysis &amp; Deconvolution."/><meta property="og:description" content="Documentation for Unfold.jl Timeseries Analysis &amp; Deconvolution."/><meta property="twitter:description" content="Documentation for Unfold.jl Timeseries Analysis &amp; Deconvolution."/><script data-outdated-warner src="../../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../../assets/documenter.js"></script><script src="../../../search_index.js"></script><script src="../../../siteinfo.js"></script><script src="../../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../../">Unfold.jl Timeseries Analysis &amp; Deconvolution</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../../">Unfold Documentation</a></li><li><a class="tocitem" href="../../../installation/">Installing Julia + Unfold.jl</a></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../../../tutorials/lm_mu/">Mass univariate LM</a></li><li><a class="tocitem" href="../../../tutorials/lm_overlap/">LM overlap correction</a></li><li><a class="tocitem" href="../../../tutorials/lmm_mu/">Mass univariate Mixed Model</a></li><li><a class="tocitem" href="../../../tutorials/lmm_overlap/">LMM + overlap correction</a></li></ul></li><li><span class="tocitem">HowTo</span><ul><li><a class="tocitem" href="../../../HowTo/multiple_events/">Overlap: Multiple events</a></li><li><a class="tocitem" href="../../../HowTo/pymne/">Import EEG with üêç PyMNE.jl</a></li><li><a class="tocitem" href="../../../HowTo/standarderrors/">Standard errors</a></li><li><a class="tocitem" href="../../../HowTo/custom_solvers/">Alternative Solvers (Robust, GPU, B2B)</a></li><li><a class="tocitem" href="../../HowTo/juliacall_unfold/">üêç Calling Unfold.jl directly from Python</a></li><li><a class="tocitem" href="../../../HowTo/lmm_pvalues/">P-values for mixedModels</a></li><li><a class="tocitem" href="../../HowTo/effects/">Marginal effects (focus on non-linear predictors)</a></li><li><a class="tocitem" href="../../HowTo/unfold_io/">Save and load Unfold models</a></li><li><a class="tocitem" href="../../HowTo/contrasts/">Change contrasts / coding schema</a></li></ul></li><li><span class="tocitem">Explanations</span><ul><li><a class="tocitem" href="../../../explanations/basisfunctions/">About basisfunctions</a></li><li><a class="tocitem" href="../nonlinear_effects/">Non-Linear effects</a></li><li class="is-active"><a class="tocitem" href>Window Length Effect</a><ul class="internal"><li class="toplevel"><a class="tocitem" href="#Init-functions"><span>Init functions</span></a></li><li class="toplevel"><a class="tocitem" href="#Init-variables"><span>Init variables</span></a></li><li class="toplevel"><a class="tocitem" href="#Generate-data-and-calculate-estimates"><span>Generate data and calculate estimates</span></a></li><li class="toplevel"><a class="tocitem" href="#Plot-results"><span>Plot results</span></a></li></ul></li><li><a class="tocitem" href="../predict/">Predictions</a></li></ul></li><li><span class="tocitem">Reference</span><ul><li><a class="tocitem" href="../../../references/extensions/">Overview of package extensions</a></li><li><a class="tocitem" href="../../../explanations/development/">Development environment</a></li><li><a class="tocitem" href="../../references/solver/">Solver/optimizer implementations</a></li><li><a class="tocitem" href="../../../references/benchmarks/">Solver benchmarks</a></li><li><a class="tocitem" href="../../../references/types/">API: Types</a></li><li><a class="tocitem" href="../../../references/functions/">API: Functions</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Explanations</a></li><li class="is-active"><a href>Window Length Effect</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Window Length Effect</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/unfoldtoolbox/Unfold.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands">ÔÇõ</span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/unfoldtoolbox/Unfold.jl/blob/main/docs/literate/explanations/window_length.jl" title="Edit source on GitHub"><span class="docs-icon fa-solid">ÔÅÑ</span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Window-length-effects"><a class="docs-heading-anchor" href="#Window-length-effects">Window length effects</a><a id="Window-length-effects-1"></a><a class="docs-heading-anchor-permalink" href="#Window-length-effects" title="Permalink"></a></h1><pre><code class="language-julia hljs">using Unfold, UnfoldSim
using CairoMakie, AlgebraOfGraphics, MakieThemes
using Random
using DataFrames, DataFramesMeta
using ColorSchemes, Colors</code></pre><div class="admonition is-category-important"><header class="admonition-header">Important</header><div class="admonition-body"><p>For analyzing real-world EEG data we recommend that researchers should ‚Äî a priori ‚Äî make an educated guess about the length of the underlying EEG activity and select this as their EW. This also suggests to use event windows with different sizes between events (as is possible with Unfold). Further, as can be seen below, when choosing longer time-windows the overfit is only of moderate size, thus we additionally recommend to generally err on the longer side, to not miss any important activity. <br/>For a more in depth explanation on this, you can read our 2023 CCN paper: <a href="https://www.biorxiv.org/content/10.1101/2023.06.05.543689v1">Skukies &amp; Ehinger, 2023</a></p></div></div><pre><code class="language-julia hljs">set_theme!(theme_ggthemr(:fresh))</code></pre><p>As opposed to classical averaged ERPs overlap corrected regression ERPs can be influenced by the chosen window length: Long estimation windows might capture all relevant event-related activity, but might introduce artifacts due to overfit, short estimation windows might not overfit, but also might not capture all (overlapping) activity, and thereby introduce bias.</p><p>Thus a common question we get is, how to specify the length of the estimation windows.</p><h1 id="Init-functions"><a class="docs-heading-anchor" href="#Init-functions">Init functions</a><a id="Init-functions-1"></a><a class="docs-heading-anchor-permalink" href="#Init-functions" title="Permalink"></a></h1><p>First we need a function that simulates some continous data; conviently we can use UnfoldSim for this</p><pre><code class="language-julia hljs">function gen_data(rng, noiselevel, sfreq)
    noise = PinkNoise(; noiselevel = noiselevel)

    dat, evts = UnfoldSim.predef_eeg(
        rng;
        sfreq = sfreq,
        p1 = (p100(; sfreq = sfreq), @formula(0 ~ 1 + condition), [5, 0], Dict()),
        n1 = (n170(; sfreq = sfreq), @formula(0 ~ 1 + condition), [5, 0], Dict()),
        p3 = (p300(; sfreq = sfreq), @formula(0 ~ 1 + continuous), [5, 0], Dict()),
        n_repeats = 20,
        noise = noise,
    )
    return dat, evts
end;</code></pre><p>Next a convience function to calculate the estimates</p><pre><code class="language-julia hljs">function calc_time_models(evts, dat, tWinList, sfreq)
    mList = []
    for twindow in tWinList
        m = fit(
            UnfoldModel,
            [Any =&gt; (@formula(0 ~ 1), firbasis(twindow, sfreq))],
            evts,
            dat,
        )
        res = coeftable(m)
        res.tWin .= string.(Ref(twindow[2]))
        push!(mList, res)
    end
    return vcat(mList...)
end;</code></pre><h1 id="Init-variables"><a class="docs-heading-anchor" href="#Init-variables">Init variables</a><a id="Init-variables-1"></a><a class="docs-heading-anchor-permalink" href="#Init-variables" title="Permalink"></a></h1><pre><code class="language-julia hljs">tWinList = [(-0.1, x) for x in [3, 2.5, 2, 1.5, 1, 0.5]]
noiselevel = 8.5
sfreq = 250;</code></pre><h1 id="Generate-data-and-calculate-estimates"><a class="docs-heading-anchor" href="#Generate-data-and-calculate-estimates">Generate data and calculate estimates</a><a id="Generate-data-and-calculate-estimates-1"></a><a class="docs-heading-anchor-permalink" href="#Generate-data-and-calculate-estimates" title="Permalink"></a></h1><pre><code class="language-julia hljs">dat, evts = gen_data(MersenneTwister(2), noiselevel, sfreq);

res = calc_time_models(evts, dat, tWinList, sfreq);</code></pre><p>We also append some additional information to the results dataframe</p><p>For comparison lets also generate the ground truth of our data; this is a bit cumbersome and you don&#39;t have to care (too much) about it</p><pre><code class="language-julia hljs">dat_gt, evts_gt = UnfoldSim.predef_eeg(;
    p1 = (p100(; sfreq = sfreq), @formula(0 ~ 1), [5], Dict()),
    sfreq = sfreq,
    n1 = (n170(; sfreq = sfreq), @formula(0 ~ 1), [5], Dict()),
    p3 = (p300(; sfreq = sfreq), @formula(0 ~ 1), [5], Dict()),
    n_repeats = 1,
    noiselevel = 0,
    return_epoched = true,
);
time_gt = range(0, length = length(dat_gt[:, 1]), step = 1 / sfreq)
unique_event = unique(res.tWin)
df_gt = DataFrame(
    tWin = reduce(vcat, fill.(unique_event, length(dat_gt[:, 1]))),
    eventname = Any,
    channel = repeat([1], length(dat_gt[:, 1]) * length(unique_event)),
    coefname = reduce(
        vcat,
        fill(&quot;GroundTruth&quot;, length(dat_gt[:, 1]) * length(unique_event)),
    ),
    estimate = repeat(dat_gt[:, 1], length(unique_event)),
    group = reduce(vcat, fill(nothing, length(dat_gt[:, 1]) * length(unique_event))),
    stderror = reduce(vcat, fill(nothing, length(dat_gt[:, 1]) * length(unique_event))),
    time = repeat(time_gt, length(unique_event)),
);</code></pre><p>And append ground truth to our results df</p><pre><code class="language-julia hljs">res_gt = vcat(res, df_gt);</code></pre><h1 id="Plot-results"><a class="docs-heading-anchor" href="#Plot-results">Plot results</a><a id="Plot-results-1"></a><a class="docs-heading-anchor-permalink" href="#Plot-results" title="Permalink"></a></h1><p>Choose which data to plot</p><pre><code class="language-julia hljs">h_t =
    AlgebraOfGraphics.data(res) * mapping(
        :time,
        :estimate,
        color = :tWin,
        group = (:tWin, :coefname) =&gt; (x, y) -&gt; string(x[2]) * y,
    );</code></pre><p>We use the following to plot some length indicator lines</p><pre><code class="language-julia hljs">untWin = unique(res_gt.tWin)
segDF = DataFrame(
    :x =&gt; hcat(repeat([-0.1], length(untWin)), parse.(Float64, untWin))[:],
    :y =&gt; repeat(reverse(1:length(untWin)), outer = 2),
)
segDF.tWin .= &quot;0.0&quot;
segDF.tWin .= segDF.x[reverse(segDF.y .+ 6)]
segDF.y = segDF.y .* 0.2 .+ 6;</code></pre><p>Layer for indicator lines</p><pre><code class="language-julia hljs">h_l =
    AlgebraOfGraphics.data(@subset(segDF, :tWin .!= &quot;3.0&quot;)) *
    mapping(:x, :y, color = :tWin, group = :tWin =&gt; x -&gt; string.(x));</code></pre><p>Ground truth Layer</p><pre><code class="language-julia hljs">h_gt =
    AlgebraOfGraphics.data(df_gt) *
    mapping(:time, :estimate, group = (:tWin, :coefname) =&gt; (x, y) -&gt; string(x) * y) *
    visual(Lines, linewidth = 5, color = Colors.Gray(0.6));</code></pre><p>Add all visuals together and draw</p><pre><code class="language-julia hljs">h1 =
    h_gt + visual(Lines, colormap = get(ColorSchemes.Blues, 0.3:0.01:1.2)) * (h_l + h_t) |&gt;
    x -&gt; draw(x, axis = (; xlabel = &quot;time [s]&quot;, ylabel = &quot;estimate [a.u.]&quot;));</code></pre><p>Add zero grid lines</p><pre><code class="language-julia hljs">h1 = hlines!(current_axis(), [0], color = Colors.Gray(0.8));
h2 = vlines!(current_axis(), [0], color = Colors.Gray(0.8));
translate!(h1, 0, 0, -1);
translate!(h2, 0, 0, -1);</code></pre><p>Plot figure</p><pre><code class="language-julia hljs">current_figure()</code></pre><img src="d5085bb4.png" alt="Example block output"/><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../nonlinear_effects/">¬´ Non-Linear effects</a><a class="docs-footer-nextpage" href="../predict/">Predictions ¬ª</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.7.0 on <span class="colophon-date" title="Friday 8 November 2024 14:34">Friday 8 November 2024</span>. Using Julia version 1.11.1.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
